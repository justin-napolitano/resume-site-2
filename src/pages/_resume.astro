---
import { loadResume } from "../lib/resume";

const r = loadResume();

// Try these common fields; adjust once we see your YAML keys:
const name = r?.basics?.name ?? r?.name ?? "Your Name";
const title = r?.basics?.label ?? r?.title ?? "";
const location = r?.basics?.location?.city
  ? `${r.basics.location.city}${r.basics.location.region ? ", " + r.basics.location.region : ""}`
  : (r?.location ?? "");
const summary = r?.basics?.summary ?? r?.summary ?? "";

const work = r?.work ?? r?.experience ?? [];
const education = r?.education ?? [];
const projects = r?.projects ?? [];
const skills = r?.skills ?? [];

const THEME_STORAGE_KEY = "resume-site-theme";
const themeToggleButtonId = "theme-toggle-button";
const themeToggleLabelId = "theme-toggle-label";
const themeStorageKeyLiteral = JSON.stringify(THEME_STORAGE_KEY);
const themeToggleButtonIdLiteral = JSON.stringify(themeToggleButtonId);
const themeToggleLabelIdLiteral = JSON.stringify(themeToggleLabelId);

const themePrefScript = `(() => {
	const STORAGE_KEY = ${themeStorageKeyLiteral};
	try {
		const stored = localStorage.getItem(STORAGE_KEY);
		if (stored === 'dark' || stored === 'light') {
			document.documentElement.dataset.theme = stored;
		} else {
			document.documentElement.removeAttribute('data-theme');
		}
	} catch (error) {
		console.warn('Theme preference unavailable', error);
	}
})();`;

const themeToggleScript = `(() => {
	const STORAGE_KEY = ${themeStorageKeyLiteral};
	const modes = ['auto', 'light', 'dark'];
	const root = document.documentElement;
	const labelId = ${themeToggleLabelIdLiteral};
	const buttonId = ${themeToggleButtonIdLiteral};

	const safeGet = () => {
		try {
			return localStorage.getItem(STORAGE_KEY);
		} catch (error) {
			console.warn('Theme preference unavailable', error);
			return null;
		}
	};

	const safeSet = (value) => {
		try {
			localStorage.setItem(STORAGE_KEY, value);
		} catch (error) {
			console.warn('Theme preference unavailable', error);
		}
	};

	const applyMode = (mode) => {
		if (mode === 'dark' || mode === 'light') {
			root.dataset.theme = mode;
		} else {
			root.removeAttribute('data-theme');
		}
		const label = document.getElementById(labelId);
		if (label) {
			label.textContent = mode;
		}
	};

	const init = () => {
		const button = document.getElementById(buttonId);
		if (!button) return;
		let current = safeGet() ?? 'auto';
		if (!modes.includes(current)) {
			current = 'auto';
		}
		applyMode(current);
		button.addEventListener('click', () => {
			const nextIndex = (modes.indexOf(current) + 1) % modes.length;
			current = modes[nextIndex];
			safeSet(current);
			applyMode(current);
		});
	};

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init, { once: true });
	} else {
		init();
	}
})();`;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{name} — Resume</title>
    <link rel="stylesheet" href="/resume.css" />
    <script is:inline set:html={themePrefScript}></script>
  </head>

  <body>
    <main class="page">
      <header class="header">
        <div>
          <h1>{name}</h1>
          {title && <p class="title">{title}</p>}
          {(location) && <p class="meta">{location}</p>}
        </div>

        <a class="btn" href="/resume.pdf" download>Download PDF</a>
      </header>

      {summary && (
        <section>
          <h2>Summary</h2>
          <p>{summary}</p>
        </section>
      )}

      {skills?.length > 0 && (
        <section>
          <h2>Skills</h2>
          <ul class="chips">
            {skills.map((s:any) => <li>{s?.name ?? s}</li>)}
          </ul>
        </section>
      )}

      {work?.length > 0 && (
        <section>
          <h2>Experience</h2>
          {work.map((w:any) => (
            <article class="item">
              <div class="item-head">
                <div>
                  <h3>{w?.position ?? w?.title}</h3>
                  <div class="sub">
                    {w?.name ?? w?.company}
                    {(w?.location) ? ` • ${w.location}` : ""}
                  </div>
                </div>
                <div class="dates">
                  {(w?.startDate ?? w?.start) ?? ""}{(w?.endDate ?? w?.end) ? ` — ${(w.endDate ?? w.end)}` : " — Present"}
                </div>
              </div>

              {(w?.summary) && <p>{w.summary}</p>}

              {(w?.highlights?.length || w?.bullets?.length) && (
                <ul>
                  {(w.highlights ?? w.bullets).map((b:string) => <li>{b}</li>)}
                </ul>
              )}
            </article>
          ))}
        </section>
      )}

      {projects?.length > 0 && (
        <section>
          <h2>Projects</h2>
          {projects.map((p:any) => (
            <article class="item">
              <div class="item-head">
                <h3>{p?.name ?? p?.title}</h3>
                {(p?.url) && <a class="link" href={p.url} target="_blank" rel="noopener">Link</a>}
              </div>
              {(p?.description) && <p>{p.description}</p>}
              {(p?.highlights?.length) && <ul>{p.highlights.map((b:string) => <li>{b}</li>)}</ul>}
            </article>
          ))}
        </section>
      )}

      {education?.length > 0 && (
        <section>
          <h2>Education</h2>
          {education.map((e:any) => (
            <article class="item">
              <div class="item-head">
                <h3>{e?.institution ?? e?.school}</h3>
                <div class="dates">{(e?.startDate ?? e?.start) ?? ""}{(e?.endDate ?? e?.end) ? ` — ${(e.endDate ?? e.end)}` : ""}</div>
              </div>
              <div class="sub">{e?.area ?? e?.degree ?? ""}</div>
            </article>
          ))}
        </section>
      )}

      <footer class="footer">
        <span>Last updated: {r?.meta?.lastUpdated ?? ""}</span>
      </footer>
    </main>
    <div class="theme-toggle" aria-live="polite">
      <button id={themeToggleButtonId} type="button">
        <span class="theme-toggle__status">Theme</span>
        <span id={themeToggleLabelId} class="theme-toggle__label">auto</span>
      </button>
    </div>
    <script is:inline set:html={themeToggleScript}></script>
  </body>
</html>
